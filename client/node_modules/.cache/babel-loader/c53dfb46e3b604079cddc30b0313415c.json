{"ast":null,"code":"if (global.GENTLY) require = GENTLY.hijack(require);\n\nvar crypto = require('crypto');\n\nvar fs = require('fs');\n\nvar util = require('util'),\n    path = require('path'),\n    File = require('./file'),\n    MultipartParser = require('./multipart_parser').MultipartParser,\n    QuerystringParser = require('./querystring_parser').QuerystringParser,\n    OctetParser = require('./octet_parser').OctetParser,\n    JSONParser = require('./json_parser').JSONParser,\n    StringDecoder = require('string_decoder').StringDecoder,\n    EventEmitter = require('events').EventEmitter,\n    Stream = require('stream').Stream,\n    os = require('os');\n\nfunction IncomingForm(opts) {\n  if (!(this instanceof IncomingForm)) return new IncomingForm(opts);\n  EventEmitter.call(this);\n  opts = opts || {};\n  this.error = null;\n  this.ended = false;\n  this.maxFields = opts.maxFields || 1000;\n  this.maxFieldsSize = opts.maxFieldsSize || 20 * 1024 * 1024;\n  this.maxFileSize = opts.maxFileSize || 200 * 1024 * 1024;\n  this.keepExtensions = opts.keepExtensions || false;\n  this.uploadDir = opts.uploadDir || os.tmpdir && os.tmpdir() || os.tmpDir();\n  this.encoding = opts.encoding || 'utf-8';\n  this.headers = null;\n  this.type = null;\n  this.hash = opts.hash || false;\n  this.multiples = opts.multiples || false;\n  this.bytesReceived = null;\n  this.bytesExpected = null;\n  this._parser = null;\n  this._flushing = 0;\n  this._fieldsSize = 0;\n  this._fileSize = 0;\n  this.openedFiles = [];\n  return this;\n}\n\nutil.inherits(IncomingForm, EventEmitter);\nexports.IncomingForm = IncomingForm;\n\nIncomingForm.prototype.parse = function (req, cb) {\n  this.pause = function () {\n    try {\n      req.pause();\n    } catch (err) {\n      // the stream was destroyed\n      if (!this.ended) {\n        // before it was completed, crash & burn\n        this._error(err);\n      }\n\n      return false;\n    }\n\n    return true;\n  };\n\n  this.resume = function () {\n    try {\n      req.resume();\n    } catch (err) {\n      // the stream was destroyed\n      if (!this.ended) {\n        // before it was completed, crash & burn\n        this._error(err);\n      }\n\n      return false;\n    }\n\n    return true;\n  }; // Setup callback first, so we don't miss anything from data events emitted\n  // immediately.\n\n\n  if (cb) {\n    var fields = {},\n        files = {};\n    this.on('field', function (name, value) {\n      fields[name] = value;\n    }).on('file', function (name, file) {\n      if (this.multiples) {\n        if (files[name]) {\n          if (!Array.isArray(files[name])) {\n            files[name] = [files[name]];\n          }\n\n          files[name].push(file);\n        } else {\n          files[name] = file;\n        }\n      } else {\n        files[name] = file;\n      }\n    }).on('error', function (err) {\n      cb(err, fields, files);\n    }).on('end', function () {\n      cb(null, fields, files);\n    });\n  } // Parse headers and setup the parser, ready to start listening for data.\n\n\n  this.writeHeaders(req.headers); // Start listening for data.\n\n  var self = this;\n  req.on('error', function (err) {\n    self._error(err);\n  }).on('aborted', function () {\n    self.emit('aborted');\n\n    self._error(new Error('Request aborted'));\n  }).on('data', function (buffer) {\n    self.write(buffer);\n  }).on('end', function () {\n    if (self.error) {\n      return;\n    }\n\n    var err = self._parser.end();\n\n    if (err) {\n      self._error(err);\n    }\n  });\n  return this;\n};\n\nIncomingForm.prototype.writeHeaders = function (headers) {\n  this.headers = headers;\n\n  this._parseContentLength();\n\n  this._parseContentType();\n};\n\nIncomingForm.prototype.write = function (buffer) {\n  if (this.error) {\n    return;\n  }\n\n  if (!this._parser) {\n    this._error(new Error('uninitialized parser'));\n\n    return;\n  }\n\n  this.bytesReceived += buffer.length;\n  this.emit('progress', this.bytesReceived, this.bytesExpected);\n\n  var bytesParsed = this._parser.write(buffer);\n\n  if (bytesParsed !== buffer.length) {\n    this._error(new Error('parser error, ' + bytesParsed + ' of ' + buffer.length + ' bytes parsed'));\n  }\n\n  return bytesParsed;\n};\n\nIncomingForm.prototype.pause = function () {\n  // this does nothing, unless overwritten in IncomingForm.parse\n  return false;\n};\n\nIncomingForm.prototype.resume = function () {\n  // this does nothing, unless overwritten in IncomingForm.parse\n  return false;\n};\n\nIncomingForm.prototype.onPart = function (part) {\n  // this method can be overwritten by the user\n  this.handlePart(part);\n};\n\nIncomingForm.prototype.handlePart = function (part) {\n  var self = this; // This MUST check exactly for undefined. You can not change it to !part.filename.\n\n  if (part.filename === undefined) {\n    var value = '',\n        decoder = new StringDecoder(this.encoding);\n    part.on('data', function (buffer) {\n      self._fieldsSize += buffer.length;\n\n      if (self._fieldsSize > self.maxFieldsSize) {\n        self._error(new Error('maxFieldsSize exceeded, received ' + self._fieldsSize + ' bytes of field data'));\n\n        return;\n      }\n\n      value += decoder.write(buffer);\n    });\n    part.on('end', function () {\n      self.emit('field', part.name, value);\n    });\n    return;\n  }\n\n  this._flushing++;\n  var file = new File({\n    path: this._uploadPath(part.filename),\n    name: part.filename,\n    type: part.mime,\n    hash: self.hash\n  });\n  this.emit('fileBegin', part.name, file);\n  file.open();\n  this.openedFiles.push(file);\n  part.on('data', function (buffer) {\n    self._fileSize += buffer.length;\n\n    if (self._fileSize > self.maxFileSize) {\n      self._error(new Error('maxFileSize exceeded, received ' + self._fileSize + ' bytes of file data'));\n\n      return;\n    }\n\n    if (buffer.length == 0) {\n      return;\n    }\n\n    self.pause();\n    file.write(buffer, function () {\n      self.resume();\n    });\n  });\n  part.on('end', function () {\n    file.end(function () {\n      self._flushing--;\n      self.emit('file', part.name, file);\n\n      self._maybeEnd();\n    });\n  });\n};\n\nfunction dummyParser(self) {\n  return {\n    end: function () {\n      self.ended = true;\n\n      self._maybeEnd();\n\n      return null;\n    }\n  };\n}\n\nIncomingForm.prototype._parseContentType = function () {\n  if (this.bytesExpected === 0) {\n    this._parser = dummyParser(this);\n    return;\n  }\n\n  if (!this.headers['content-type']) {\n    this._error(new Error('bad content-type header, no content-type'));\n\n    return;\n  }\n\n  if (this.headers['content-type'].match(/octet-stream/i)) {\n    this._initOctetStream();\n\n    return;\n  }\n\n  if (this.headers['content-type'].match(/urlencoded/i)) {\n    this._initUrlencoded();\n\n    return;\n  }\n\n  if (this.headers['content-type'].match(/multipart/i)) {\n    var m = this.headers['content-type'].match(/boundary=(?:\"([^\"]+)\"|([^;]+))/i);\n\n    if (m) {\n      this._initMultipart(m[1] || m[2]);\n    } else {\n      this._error(new Error('bad content-type header, no multipart boundary'));\n    }\n\n    return;\n  }\n\n  if (this.headers['content-type'].match(/json/i)) {\n    this._initJSONencoded();\n\n    return;\n  }\n\n  this._error(new Error('bad content-type header, unknown content-type: ' + this.headers['content-type']));\n};\n\nIncomingForm.prototype._error = function (err) {\n  if (this.error || this.ended) {\n    return;\n  }\n\n  this.error = err;\n  this.emit('error', err);\n\n  if (Array.isArray(this.openedFiles)) {\n    this.openedFiles.forEach(function (file) {\n      file._writeStream.destroy();\n\n      setTimeout(fs.unlink, 0, file.path, function (error) {});\n    });\n  }\n};\n\nIncomingForm.prototype._parseContentLength = function () {\n  this.bytesReceived = 0;\n\n  if (this.headers['content-length']) {\n    this.bytesExpected = parseInt(this.headers['content-length'], 10);\n  } else if (this.headers['transfer-encoding'] === undefined) {\n    this.bytesExpected = 0;\n  }\n\n  if (this.bytesExpected !== null) {\n    this.emit('progress', this.bytesReceived, this.bytesExpected);\n  }\n};\n\nIncomingForm.prototype._newParser = function () {\n  return new MultipartParser();\n};\n\nIncomingForm.prototype._initMultipart = function (boundary) {\n  this.type = 'multipart';\n  var parser = new MultipartParser(),\n      self = this,\n      headerField,\n      headerValue,\n      part;\n  parser.initWithBoundary(boundary);\n\n  parser.onPartBegin = function () {\n    part = new Stream();\n    part.readable = true;\n    part.headers = {};\n    part.name = null;\n    part.filename = null;\n    part.mime = null;\n    part.transferEncoding = 'binary';\n    part.transferBuffer = '';\n    headerField = '';\n    headerValue = '';\n  };\n\n  parser.onHeaderField = function (b, start, end) {\n    headerField += b.toString(self.encoding, start, end);\n  };\n\n  parser.onHeaderValue = function (b, start, end) {\n    headerValue += b.toString(self.encoding, start, end);\n  };\n\n  parser.onHeaderEnd = function () {\n    headerField = headerField.toLowerCase();\n    part.headers[headerField] = headerValue; // matches either a quoted-string or a token (RFC 2616 section 19.5.1)\n\n    var m = headerValue.match(/\\bname=(\"([^\"]*)\"|([^\\(\\)<>@,;:\\\\\"\\/\\[\\]\\?=\\{\\}\\s\\t/]+))/i);\n\n    if (headerField == 'content-disposition') {\n      if (m) {\n        part.name = m[2] || m[3] || '';\n      }\n\n      part.filename = self._fileName(headerValue);\n    } else if (headerField == 'content-type') {\n      part.mime = headerValue;\n    } else if (headerField == 'content-transfer-encoding') {\n      part.transferEncoding = headerValue.toLowerCase();\n    }\n\n    headerField = '';\n    headerValue = '';\n  };\n\n  parser.onHeadersEnd = function () {\n    switch (part.transferEncoding) {\n      case 'binary':\n      case '7bit':\n      case '8bit':\n        parser.onPartData = function (b, start, end) {\n          part.emit('data', b.slice(start, end));\n        };\n\n        parser.onPartEnd = function () {\n          part.emit('end');\n        };\n\n        break;\n\n      case 'base64':\n        parser.onPartData = function (b, start, end) {\n          part.transferBuffer += b.slice(start, end).toString('ascii');\n          /*\n          four bytes (chars) in base64 converts to three bytes in binary\n          encoding. So we should always work with a number of bytes that\n          can be divided by 4, it will result in a number of buytes that\n          can be divided vy 3.\n          */\n\n          var offset = parseInt(part.transferBuffer.length / 4, 10) * 4;\n          part.emit('data', new Buffer(part.transferBuffer.substring(0, offset), 'base64'));\n          part.transferBuffer = part.transferBuffer.substring(offset);\n        };\n\n        parser.onPartEnd = function () {\n          part.emit('data', new Buffer(part.transferBuffer, 'base64'));\n          part.emit('end');\n        };\n\n        break;\n\n      default:\n        return self._error(new Error('unknown transfer-encoding'));\n    }\n\n    self.onPart(part);\n  };\n\n  parser.onEnd = function () {\n    self.ended = true;\n\n    self._maybeEnd();\n  };\n\n  this._parser = parser;\n};\n\nIncomingForm.prototype._fileName = function (headerValue) {\n  // matches either a quoted-string or a token (RFC 2616 section 19.5.1)\n  var m = headerValue.match(/\\bfilename=(\"(.*?)\"|([^\\(\\)<>@,;:\\\\\"\\/\\[\\]\\?=\\{\\}\\s\\t/]+))($|;\\s)/i);\n  if (!m) return;\n  var match = m[2] || m[3] || '';\n  var filename = match.substr(match.lastIndexOf('\\\\') + 1);\n  filename = filename.replace(/%22/g, '\"');\n  filename = filename.replace(/&#([\\d]{4});/g, function (m, code) {\n    return String.fromCharCode(code);\n  });\n  return filename;\n};\n\nIncomingForm.prototype._initUrlencoded = function () {\n  this.type = 'urlencoded';\n  var parser = new QuerystringParser(this.maxFields),\n      self = this;\n\n  parser.onField = function (key, val) {\n    self.emit('field', key, val);\n  };\n\n  parser.onEnd = function () {\n    self.ended = true;\n\n    self._maybeEnd();\n  };\n\n  this._parser = parser;\n};\n\nIncomingForm.prototype._initOctetStream = function () {\n  this.type = 'octet-stream';\n  var filename = this.headers['x-file-name'];\n  var mime = this.headers['content-type'];\n  var file = new File({\n    path: this._uploadPath(filename),\n    name: filename,\n    type: mime\n  });\n  this.emit('fileBegin', filename, file);\n  file.open();\n  this.openedFiles.push(file);\n  this._flushing++;\n  var self = this;\n  self._parser = new OctetParser(); //Keep track of writes that haven't finished so we don't emit the file before it's done being written\n\n  var outstandingWrites = 0;\n\n  self._parser.on('data', function (buffer) {\n    self.pause();\n    outstandingWrites++;\n    file.write(buffer, function () {\n      outstandingWrites--;\n      self.resume();\n\n      if (self.ended) {\n        self._parser.emit('doneWritingFile');\n      }\n    });\n  });\n\n  self._parser.on('end', function () {\n    self._flushing--;\n    self.ended = true;\n\n    var done = function () {\n      file.end(function () {\n        self.emit('file', 'file', file);\n\n        self._maybeEnd();\n      });\n    };\n\n    if (outstandingWrites === 0) {\n      done();\n    } else {\n      self._parser.once('doneWritingFile', done);\n    }\n  });\n};\n\nIncomingForm.prototype._initJSONencoded = function () {\n  this.type = 'json';\n  var parser = new JSONParser(this),\n      self = this;\n\n  parser.onField = function (key, val) {\n    self.emit('field', key, val);\n  };\n\n  parser.onEnd = function () {\n    self.ended = true;\n\n    self._maybeEnd();\n  };\n\n  this._parser = parser;\n};\n\nIncomingForm.prototype._uploadPath = function (filename) {\n  var buf = crypto.randomBytes(16);\n  var name = 'upload_' + buf.toString('hex');\n\n  if (this.keepExtensions) {\n    var ext = path.extname(filename);\n    ext = ext.replace(/(\\.[a-z0-9]+).*/i, '$1');\n    name += ext;\n  }\n\n  return path.join(this.uploadDir, name);\n};\n\nIncomingForm.prototype._maybeEnd = function () {\n  if (!this.ended || this._flushing || this.error) {\n    return;\n  }\n\n  this.emit('end');\n};","map":{"version":3,"sources":["C:/Users/aman/Desktop/Dev-connector/node_modules/formidable/lib/incoming_form.js"],"names":["global","GENTLY","require","hijack","crypto","fs","util","path","File","MultipartParser","QuerystringParser","OctetParser","JSONParser","StringDecoder","EventEmitter","Stream","os","IncomingForm","opts","call","error","ended","maxFields","maxFieldsSize","maxFileSize","keepExtensions","uploadDir","tmpdir","tmpDir","encoding","headers","type","hash","multiples","bytesReceived","bytesExpected","_parser","_flushing","_fieldsSize","_fileSize","openedFiles","inherits","exports","prototype","parse","req","cb","pause","err","_error","resume","fields","files","on","name","value","file","Array","isArray","push","writeHeaders","self","emit","Error","buffer","write","end","_parseContentLength","_parseContentType","length","bytesParsed","onPart","part","handlePart","filename","undefined","decoder","_uploadPath","mime","open","_maybeEnd","dummyParser","match","_initOctetStream","_initUrlencoded","m","_initMultipart","_initJSONencoded","forEach","_writeStream","destroy","setTimeout","unlink","parseInt","_newParser","boundary","parser","headerField","headerValue","initWithBoundary","onPartBegin","readable","transferEncoding","transferBuffer","onHeaderField","b","start","toString","onHeaderValue","onHeaderEnd","toLowerCase","_fileName","onHeadersEnd","onPartData","slice","onPartEnd","offset","Buffer","substring","onEnd","substr","lastIndexOf","replace","code","String","fromCharCode","onField","key","val","outstandingWrites","done","once","buf","randomBytes","ext","extname","join"],"mappings":"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","sourcesContent":["if (global.GENTLY) require = GENTLY.hijack(require);\n\nvar crypto = require('crypto');\nvar fs = require('fs');\nvar util = require('util'),\n    path = require('path'),\n    File = require('./file'),\n    MultipartParser = require('./multipart_parser').MultipartParser,\n    QuerystringParser = require('./querystring_parser').QuerystringParser,\n    OctetParser       = require('./octet_parser').OctetParser,\n    JSONParser = require('./json_parser').JSONParser,\n    StringDecoder = require('string_decoder').StringDecoder,\n    EventEmitter = require('events').EventEmitter,\n    Stream = require('stream').Stream,\n    os = require('os');\n\nfunction IncomingForm(opts) {\n  if (!(this instanceof IncomingForm)) return new IncomingForm(opts);\n  EventEmitter.call(this);\n\n  opts=opts||{};\n\n  this.error = null;\n  this.ended = false;\n\n  this.maxFields = opts.maxFields || 1000;\n  this.maxFieldsSize = opts.maxFieldsSize || 20 * 1024 * 1024;\n  this.maxFileSize = opts.maxFileSize || 200 * 1024 * 1024;\n  this.keepExtensions = opts.keepExtensions || false;\n  this.uploadDir = opts.uploadDir || (os.tmpdir && os.tmpdir()) || os.tmpDir();\n  this.encoding = opts.encoding || 'utf-8';\n  this.headers = null;\n  this.type = null;\n  this.hash = opts.hash || false;\n  this.multiples = opts.multiples || false;\n\n  this.bytesReceived = null;\n  this.bytesExpected = null;\n\n  this._parser = null;\n  this._flushing = 0;\n  this._fieldsSize = 0;\n  this._fileSize = 0;\n  this.openedFiles = [];\n\n  return this;\n}\nutil.inherits(IncomingForm, EventEmitter);\nexports.IncomingForm = IncomingForm;\n\nIncomingForm.prototype.parse = function(req, cb) {\n  this.pause = function() {\n    try {\n      req.pause();\n    } catch (err) {\n      // the stream was destroyed\n      if (!this.ended) {\n        // before it was completed, crash & burn\n        this._error(err);\n      }\n      return false;\n    }\n    return true;\n  };\n\n  this.resume = function() {\n    try {\n      req.resume();\n    } catch (err) {\n      // the stream was destroyed\n      if (!this.ended) {\n        // before it was completed, crash & burn\n        this._error(err);\n      }\n      return false;\n    }\n\n    return true;\n  };\n\n  // Setup callback first, so we don't miss anything from data events emitted\n  // immediately.\n  if (cb) {\n    var fields = {}, files = {};\n    this\n      .on('field', function(name, value) {\n        fields[name] = value;\n      })\n      .on('file', function(name, file) {\n        if (this.multiples) {\n          if (files[name]) {\n            if (!Array.isArray(files[name])) {\n              files[name] = [files[name]];\n            }\n            files[name].push(file);\n          } else {\n            files[name] = file;\n          }\n        } else {\n          files[name] = file;\n        }\n      })\n      .on('error', function(err) {\n        cb(err, fields, files);\n      })\n      .on('end', function() {\n        cb(null, fields, files);\n      });\n  }\n\n  // Parse headers and setup the parser, ready to start listening for data.\n  this.writeHeaders(req.headers);\n\n  // Start listening for data.\n  var self = this;\n  req\n    .on('error', function(err) {\n      self._error(err);\n    })\n    .on('aborted', function() {\n      self.emit('aborted');\n      self._error(new Error('Request aborted'));\n    })\n    .on('data', function(buffer) {\n      self.write(buffer);\n    })\n    .on('end', function() {\n      if (self.error) {\n        return;\n      }\n\n      var err = self._parser.end();\n      if (err) {\n        self._error(err);\n      }\n    });\n\n  return this;\n};\n\nIncomingForm.prototype.writeHeaders = function(headers) {\n  this.headers = headers;\n  this._parseContentLength();\n  this._parseContentType();\n};\n\nIncomingForm.prototype.write = function(buffer) {\n  if (this.error) {\n    return;\n  }\n  if (!this._parser) {\n    this._error(new Error('uninitialized parser'));\n    return;\n  }\n\n  this.bytesReceived += buffer.length;\n  this.emit('progress', this.bytesReceived, this.bytesExpected);\n\n  var bytesParsed = this._parser.write(buffer);\n  if (bytesParsed !== buffer.length) {\n    this._error(new Error('parser error, '+bytesParsed+' of '+buffer.length+' bytes parsed'));\n  }\n\n  return bytesParsed;\n};\n\nIncomingForm.prototype.pause = function() {\n  // this does nothing, unless overwritten in IncomingForm.parse\n  return false;\n};\n\nIncomingForm.prototype.resume = function() {\n  // this does nothing, unless overwritten in IncomingForm.parse\n  return false;\n};\n\nIncomingForm.prototype.onPart = function(part) {\n  // this method can be overwritten by the user\n  this.handlePart(part);\n};\n\nIncomingForm.prototype.handlePart = function(part) {\n  var self = this;\n\n  // This MUST check exactly for undefined. You can not change it to !part.filename.\n  if (part.filename === undefined) {\n    var value = ''\n      , decoder = new StringDecoder(this.encoding);\n\n    part.on('data', function(buffer) {\n      self._fieldsSize += buffer.length;\n      if (self._fieldsSize > self.maxFieldsSize) {\n        self._error(new Error('maxFieldsSize exceeded, received '+self._fieldsSize+' bytes of field data'));\n        return;\n      }\n      value += decoder.write(buffer);\n    });\n\n    part.on('end', function() {\n      self.emit('field', part.name, value);\n    });\n    return;\n  }\n\n  this._flushing++;\n\n  var file = new File({\n    path: this._uploadPath(part.filename),\n    name: part.filename,\n    type: part.mime,\n    hash: self.hash\n  });\n\n  this.emit('fileBegin', part.name, file);\n\n  file.open();\n  this.openedFiles.push(file);\n\n  part.on('data', function(buffer) {\n    self._fileSize += buffer.length;\n    if (self._fileSize > self.maxFileSize) {\n      self._error(new Error('maxFileSize exceeded, received '+self._fileSize+' bytes of file data'));\n      return;\n    }\n    if (buffer.length == 0) {\n      return;\n    }\n    self.pause();\n    file.write(buffer, function() {\n      self.resume();\n    });\n  });\n\n  part.on('end', function() {\n    file.end(function() {\n      self._flushing--;\n      self.emit('file', part.name, file);\n      self._maybeEnd();\n    });\n  });\n};\n\nfunction dummyParser(self) {\n  return {\n    end: function () {\n      self.ended = true;\n      self._maybeEnd();\n      return null;\n    }\n  };\n}\n\nIncomingForm.prototype._parseContentType = function() {\n  if (this.bytesExpected === 0) {\n    this._parser = dummyParser(this);\n    return;\n  }\n\n  if (!this.headers['content-type']) {\n    this._error(new Error('bad content-type header, no content-type'));\n    return;\n  }\n\n  if (this.headers['content-type'].match(/octet-stream/i)) {\n    this._initOctetStream();\n    return;\n  }\n\n  if (this.headers['content-type'].match(/urlencoded/i)) {\n    this._initUrlencoded();\n    return;\n  }\n\n  if (this.headers['content-type'].match(/multipart/i)) {\n    var m = this.headers['content-type'].match(/boundary=(?:\"([^\"]+)\"|([^;]+))/i);\n    if (m) {\n      this._initMultipart(m[1] || m[2]);\n    } else {\n      this._error(new Error('bad content-type header, no multipart boundary'));\n    }\n    return;\n  }\n\n  if (this.headers['content-type'].match(/json/i)) {\n    this._initJSONencoded();\n    return;\n  }\n\n  this._error(new Error('bad content-type header, unknown content-type: '+this.headers['content-type']));\n};\n\nIncomingForm.prototype._error = function(err) {\n  if (this.error || this.ended) {\n    return;\n  }\n\n  this.error = err;\n  this.emit('error', err);\n\n  if (Array.isArray(this.openedFiles)) {\n    this.openedFiles.forEach(function(file) {\n      file._writeStream.destroy();\n      setTimeout(fs.unlink, 0, file.path, function(error) { });\n    });\n  }\n};\n\nIncomingForm.prototype._parseContentLength = function() {\n  this.bytesReceived = 0;\n  if (this.headers['content-length']) {\n    this.bytesExpected = parseInt(this.headers['content-length'], 10);\n  } else if (this.headers['transfer-encoding'] === undefined) {\n    this.bytesExpected = 0;\n  }\n\n  if (this.bytesExpected !== null) {\n    this.emit('progress', this.bytesReceived, this.bytesExpected);\n  }\n};\n\nIncomingForm.prototype._newParser = function() {\n  return new MultipartParser();\n};\n\nIncomingForm.prototype._initMultipart = function(boundary) {\n  this.type = 'multipart';\n\n  var parser = new MultipartParser(),\n      self = this,\n      headerField,\n      headerValue,\n      part;\n\n  parser.initWithBoundary(boundary);\n\n  parser.onPartBegin = function() {\n    part = new Stream();\n    part.readable = true;\n    part.headers = {};\n    part.name = null;\n    part.filename = null;\n    part.mime = null;\n\n    part.transferEncoding = 'binary';\n    part.transferBuffer = '';\n\n    headerField = '';\n    headerValue = '';\n  };\n\n  parser.onHeaderField = function(b, start, end) {\n    headerField += b.toString(self.encoding, start, end);\n  };\n\n  parser.onHeaderValue = function(b, start, end) {\n    headerValue += b.toString(self.encoding, start, end);\n  };\n\n  parser.onHeaderEnd = function() {\n    headerField = headerField.toLowerCase();\n    part.headers[headerField] = headerValue;\n\n    // matches either a quoted-string or a token (RFC 2616 section 19.5.1)\n    var m = headerValue.match(/\\bname=(\"([^\"]*)\"|([^\\(\\)<>@,;:\\\\\"\\/\\[\\]\\?=\\{\\}\\s\\t/]+))/i);\n    if (headerField == 'content-disposition') {\n      if (m) {\n        part.name = m[2] || m[3] || '';\n      }\n\n      part.filename = self._fileName(headerValue);\n    } else if (headerField == 'content-type') {\n      part.mime = headerValue;\n    } else if (headerField == 'content-transfer-encoding') {\n      part.transferEncoding = headerValue.toLowerCase();\n    }\n\n    headerField = '';\n    headerValue = '';\n  };\n\n  parser.onHeadersEnd = function() {\n    switch(part.transferEncoding){\n      case 'binary':\n      case '7bit':\n      case '8bit':\n      parser.onPartData = function(b, start, end) {\n        part.emit('data', b.slice(start, end));\n      };\n\n      parser.onPartEnd = function() {\n        part.emit('end');\n      };\n      break;\n\n      case 'base64':\n      parser.onPartData = function(b, start, end) {\n        part.transferBuffer += b.slice(start, end).toString('ascii');\n\n        /*\n        four bytes (chars) in base64 converts to three bytes in binary\n        encoding. So we should always work with a number of bytes that\n        can be divided by 4, it will result in a number of buytes that\n        can be divided vy 3.\n        */\n        var offset = parseInt(part.transferBuffer.length / 4, 10) * 4;\n        part.emit('data', new Buffer(part.transferBuffer.substring(0, offset), 'base64'));\n        part.transferBuffer = part.transferBuffer.substring(offset);\n      };\n\n      parser.onPartEnd = function() {\n        part.emit('data', new Buffer(part.transferBuffer, 'base64'));\n        part.emit('end');\n      };\n      break;\n\n      default:\n      return self._error(new Error('unknown transfer-encoding'));\n    }\n\n    self.onPart(part);\n  };\n\n\n  parser.onEnd = function() {\n    self.ended = true;\n    self._maybeEnd();\n  };\n\n  this._parser = parser;\n};\n\nIncomingForm.prototype._fileName = function(headerValue) {\n  // matches either a quoted-string or a token (RFC 2616 section 19.5.1)\n  var m = headerValue.match(/\\bfilename=(\"(.*?)\"|([^\\(\\)<>@,;:\\\\\"\\/\\[\\]\\?=\\{\\}\\s\\t/]+))($|;\\s)/i);\n  if (!m) return;\n\n  var match = m[2] || m[3] || '';\n  var filename = match.substr(match.lastIndexOf('\\\\') + 1);\n  filename = filename.replace(/%22/g, '\"');\n  filename = filename.replace(/&#([\\d]{4});/g, function(m, code) {\n    return String.fromCharCode(code);\n  });\n  return filename;\n};\n\nIncomingForm.prototype._initUrlencoded = function() {\n  this.type = 'urlencoded';\n\n  var parser = new QuerystringParser(this.maxFields)\n    , self = this;\n\n  parser.onField = function(key, val) {\n    self.emit('field', key, val);\n  };\n\n  parser.onEnd = function() {\n    self.ended = true;\n    self._maybeEnd();\n  };\n\n  this._parser = parser;\n};\n\nIncomingForm.prototype._initOctetStream = function() {\n  this.type = 'octet-stream';\n  var filename = this.headers['x-file-name'];\n  var mime = this.headers['content-type'];\n\n  var file = new File({\n    path: this._uploadPath(filename),\n    name: filename,\n    type: mime\n  });\n\n  this.emit('fileBegin', filename, file);\n  file.open();\n  this.openedFiles.push(file);\n  this._flushing++;\n\n  var self = this;\n\n  self._parser = new OctetParser();\n\n  //Keep track of writes that haven't finished so we don't emit the file before it's done being written\n  var outstandingWrites = 0;\n\n  self._parser.on('data', function(buffer){\n    self.pause();\n    outstandingWrites++;\n\n    file.write(buffer, function() {\n      outstandingWrites--;\n      self.resume();\n\n      if(self.ended){\n        self._parser.emit('doneWritingFile');\n      }\n    });\n  });\n\n  self._parser.on('end', function(){\n    self._flushing--;\n    self.ended = true;\n\n    var done = function(){\n      file.end(function() {\n        self.emit('file', 'file', file);\n        self._maybeEnd();\n      });\n    };\n\n    if(outstandingWrites === 0){\n      done();\n    } else {\n      self._parser.once('doneWritingFile', done);\n    }\n  });\n};\n\nIncomingForm.prototype._initJSONencoded = function() {\n  this.type = 'json';\n\n  var parser = new JSONParser(this)\n    , self = this;\n\n  parser.onField = function(key, val) {\n    self.emit('field', key, val);\n  };\n\n  parser.onEnd = function() {\n    self.ended = true;\n    self._maybeEnd();\n  };\n\n  this._parser = parser;\n};\n\nIncomingForm.prototype._uploadPath = function(filename) {\n  var buf = crypto.randomBytes(16);\n  var name = 'upload_' + buf.toString('hex');\n\n  if (this.keepExtensions) {\n    var ext = path.extname(filename);\n    ext     = ext.replace(/(\\.[a-z0-9]+).*/i, '$1');\n\n    name += ext;\n  }\n\n  return path.join(this.uploadDir, name);\n};\n\nIncomingForm.prototype._maybeEnd = function() {\n  if (!this.ended || this._flushing || this.error) {\n    return;\n  }\n\n  this.emit('end');\n};\n"]},"metadata":{},"sourceType":"script"}